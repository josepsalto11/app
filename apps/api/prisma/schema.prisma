generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  displayName   String?
  timeZone      String   @default("Europe/Madrid")

  // Preferences
  defaultBufferMinutes Int @default(10)
  prepMinutes          Int @default(5)
  preferMode           String @default("auto") // auto|drive|transit|walk

  places        Place[]
  trips         Trip[]
  events        Event[]
  commutes      CommuteProfile[]
}

model Place {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  label     String   // "Casa", "Trabajo"
  address   String?
  lat       Float
  lng       Float

  @@unique([userId, label])
}

model Event {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider  String   // google|apple|microsoft|manual
  providerEventId String?

  title     String
  locationText String?
  startAt   DateTime
  endAt     DateTime?

  destLat   Float?
  destLng   Float?

  // planning snapshots
  lastPlannedAt DateTime?
  lastMode      String?
  lastLeaveAt   DateTime?
  lastEtaSec    Int?

  @@index([userId, startAt])
}

model Trip {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventId     String?
  event       Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)

  originLat   Float
  originLng   Float
  destLat     Float
  destLng     Float

  mode        String   // drive|transit|walk
  provider    String   // google|otp|osrm
  etaSec      Int
  distanceM   Int
  summary     String?

  reliabilityScore Float @default(0.5) // 0..1
  riskPercent      Int   @default(20)  // 0..100

  plannedLeaveAt DateTime
  eventStartAt   DateTime

  // feedback (learning)
  arrivedAt      DateTime?
  outcome        String? // ontime|tight|late
  reason         String? // traffic|transit_delay|prep|parking|other
  extraDelaySec  Int?
}

model CommuteProfile {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String   // "Casa â†’ Trabajo"
  originPlaceId String?
  destPlaceId   String?
  originLat   Float?
  originLng   Float?
  destLat     Float?
  destLng     Float?

  weekdayMask Int @default(62) // bitmask Mon..Sun (Mon=2, Tue=4,...). 62=Mon-Fri
  preferredMode String @default("auto")

  // Learned margins (seconds)
  learnedPrepSec   Int @default(300)
  learnedBufferSec Int @default(600)
  learnedParkingSec Int @default(0)

  @@index([userId, name])
}
